<?php 
session_start();
date_default_timezone_set('AMERICA/MEXICO_CITY');
if(isset($_POST['contactos_lista']))
{
	contactos_lista();
}
elseif(isset($_POST['registrar_contacto']))
{
	registrar_contacto();
}
elseif(isset($_POST['eliminando_contacto']))
{
	eliminando_contacto();
}
else if(isset($_POST['buscar_datos_para_actualizar_y_actualizar']))
{
	buscar_datos_para_actualizar_y_actualizar();
}

function llamar_conexion()
{
	include('conexion.php');
	$conexion=new conexion;	

	return $conexion_final=$conexion->abrir();

}

function buscar_datos_para_actualizar_y_actualizar()
{
	try 
	{
		$conexion =llamar_conexion();
		if($conexion)
		{
				$id_contacto = $_POST['buscar_datos_para_actualizar_y_actualizar'];
				$buscando_y_actualizar=$_POST['buscando_y_actualizar'];

				switch ($buscando_y_actualizar) 
				{
					case '1':
						$contacto_ins ="SELECT*from contactos
						where id_contacto=:id_contacto";
						$query_contacto = $conexion->prepare($contacto_ins);
						$query_contacto->execute(array(":id_contacto"=>$id_contacto));

						foreach ($query_contacto as $datos) 
						{
							$respuestas[]=str_replace('_',' ',$datos['apellido_paterno_contacto']);
							$respuestas[]=str_replace('_',' ',$datos['apellido_materno_contacto']);
							$respuestas[]=str_replace('_',' ',$datos['nombre_contacto']);
							$respuestas[]=str_replace('_',' ',$datos['tipo_contacto']);
							$respuestas[]=$datos['telefono_contacto'];
							$respuestas[]=$datos['correo_contaco'];
						}
						$respuesta_final['data']=$respuestas;
						echo json_encode($respuesta_final);
						break;
					
					default:
						//actualizando los datos
						$nombre_contacto=mb_strtoupper(str_replace(' ','_',$_POST['nombre_contacto']),'UTF-8');
						$telefono_contacto=$_POST['telefono_contacto'];
						$tipo_contacto = mb_strtoupper(str_replace(' ','_',$_POST['tipo_contacto']),'UTF-8');
						$correo=$_POST['correo'];
						$fecha_hoy=date('Y-m-d H:i:s',time());
						$usuario = $_SESSION['usuario']['user'];

						$actualizar_ins = "UPDATE contactos
						set
						nombre_contacto=:nombre_contacto,
						tipo_contacto=:tipo_contacto,
						telefono_contacto=:telefono_contacto,
						correo_contaco=:correo_contaco
						where id_contacto=:id_contacto
						";
						$query_actu=$conexion->prepare($actualizar_ins);
						$query_actu->execute(array(
							":nombre_contacto"=>$nombre_contacto,
							":tipo_contacto"=>$tipo_contacto,
							":telefono_contacto"=>$telefono_contacto,
							":correo_contaco"=>$correo,
							":id_contacto"=>$id_contacto,

						));
						if($query_actu==true)
						{
							echo '1';
						}
						else
						{
							echo '0';
						}
						break;
				}

				$respuestas=array();

		}	
		else
		{
			echo'ERROR 234.BUSCAR DATOS PARA ACTUALIZAR. El servidor no responde';
		}

	} catch (PDOException $e) 
	{
		echo$e;	
	}
}

function eliminando_contacto()
{
	try 
	{
		$conexion=llamar_conexion();
		if($conexion)
		{
			$id_contacto=$_POST['eliminando_contacto'];
			$delete="DELETE FROM contactos
			where id_contacto=:id_contacto";
			$query_del=$conexion->prepare($delete);
			$query_del->execute(array(
				":id_contacto"=>$id_contacto
			));

			if($query_del==true)
			{
				echo '1';

			}
			else
			{
				echo'0';
			}
		}	
		else
		{
			echo'ERROR 342.ELIMINAR CONTACTO.EL servidor no responde';
		}
	} catch (PDOException $e) 
	{
		echo $e;	
	}
}
function registrar_contacto()
{
	try 
	{
		$conexion = llamar_conexion();
		if($conexion)
		{	
			$apellido_paterno_contacto=mb_strtoupper(str_replace(' ','_',trim($_POST['apellido_paterno_contacto'])),'UTF-8');
			$apellido_materno_contacto=mb_strtoupper(str_replace(' ','_',trim($_POST['apellido_materno_contacto'])),'UTF-8');
			$nombre_contacto=mb_strtoupper(str_replace(' ','_',trim($_POST['nombre_contacto'])),'UTF-8');
			$telefono_contacto=$_POST['telefono_contacto'];
				$tipo_contacto = mb_strtoupper(str_replace(' ','_',$_POST['tipo_contacto']),'UTF-8');
				$correo=$_POST['correo'];
			$fecha_hoy=date('Y-m-d H:i:s',time());
			$usuario = $_SESSION['usuario']['user'];

			//verificando si existe el coontacto completo
			$Verificando_contacto = 
			"SELECT
			apellido_paterno_contacto,
			apellido_materno_contacto,
			nombre_contacto
			from
			contactos
			where
			apellido_paterno_contacto=:apellido_paterno_contacto
			and
			apellido_materno_contacto=:apellido_materno_contacto
			and
			nombre_contacto=:nombre_contacto
			and
			dio_alta_contacto=:dio_alta_contacto
			";
			$query_verificando=$conexion->prepare($Verificando_contacto);
			$query_verificando->execute(array(
				":apellido_paterno_contacto"=>$apellido_paterno_contacto,
				":apellido_materno_contacto"=>$apellido_materno_contacto,
				":nombre_contacto"=>$nombre_contacto,
				":dio_alta_contacto"=>$usuario
			));
			$fila=$query_verificando->rowCount();
			if($fila>0)
			{
				echo'si_hay';
			}
			else
			{
				$insertar_contacto="INSERT INTO contactos
					(
						apellido_paterno_contacto,
						apellido_materno_contacto,
						nombre_contacto,
						tipo_contacto,
						telefono_contacto,
						correo_contaco,
						fecha_alta_contacto,
						dio_alta_contacto
					)
					values
					(
						:apellido_paterno_contacto,
						:apellido_materno_contacto,
						:nombre_contacto,
						:tipo_contacto,
						:telefono_contacto,
						:correo_contaco,
						:fecha_alta_contacto,
						:dio_alta_contacto
					)";
					$query_insertar=$conexion->prepare($insertar_contacto);
					$query_insertar->execute(array(
						":apellido_paterno_contacto"=>$apellido_paterno_contacto,
						":apellido_materno_contacto"=>$apellido_materno_contacto,
						":nombre_contacto"=>$nombre_contacto,
						":tipo_contacto"=>$tipo_contacto,
						":telefono_contacto"=>$telefono_contacto,
						":correo_contaco"=>$correo,
						":fecha_alta_contacto"=>$fecha_hoy,
						":dio_alta_contacto"=>$usuario
					));

					if($query_insertar==true)
					{
						echo'1';
					}
					else 
					{
						echo'0';
					}
			}
			
			/*//veridicando que el telefono no este registrado
			$buscando_el_telefono="SELECT*FROM contactos where
			telefono_contacto=:telefono_contacto";
			$query_telefono=$conexion->prepare($buscando_el_telefono);
			$query_telefono->execute(array(
				":telefono_contacto"=>$telefono_contacto
			));
			$filas_telefono=$query_telefono->rowCount();
			if($filas_telefono>0)
			{
				echo'te';
				exit();
			}*/
			
			//veridicando que el telefono no este registrado
			/*$buscando_el_correo="SELECT*FROM contactos where
			correo_contaco=:correo_contaco";
			$query_correo=$conexion->prepare($buscando_el_correo);
			$query_correo->execute(array(
				":correo_contaco"=>$correo
			));
			$filas_correo=$query_correo->rowCount();
			if($filas_correo>0)
			{
				echo'co';
				exit();
			}
*/

				

					


		}	
		else
		{
			echo "ERROR 112. REGISTRO DE CONTACTO.NO RESPONDE EL SERVIDOR";
		}
	} 
	catch (PDOException $e) 
	{
		echo $e;	
	}
}

function contactos_lista()
{
	try 
	{
		$conexion=llamar_conexion();
		if($conexion)
		{
			$arreglo=array();
			$datos_finales=array();
			$usuario=$_SESSION['usuario']['user'];
			$i=0;
			$j=1;
			$contactos_todos="";
			$lista="SELECT*FROM contactos 
			where dio_alta_contacto=:dio_alta_contacto 
			order by nombre_contacto asc";
			$query_lista=$conexion->prepare($lista);
			$query_lista->execute(
				array(":dio_alta_contacto"=>$usuario
			));
			$filas=$query_lista->rowCount();
			if($filas>0)
			{
				switch ($_POST['contactos_lista']) 
				{
					case 1:
						foreach ($query_lista as $datos) 
						{
							$arreglo['nombre_contacto'][]=str_replace('_',' ',mb_strtoupper($datos['apellido_paterno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_materno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['nombre_contacto'],'UTF-8'));

						}
						$datos_finales['contacto']=$arreglo;
						echo json_encode($datos_finales);
						exit();	
						break;
					
					case 2:
					
						$agentes='<optgroup label="AGENTES">';
						$subagentes='<optgroup label="SUBAGENTES">';
						$empleado='<optgroup label="EMPLEADO">';
						$clientes_directos='<optgroup label="CLIENTE DIRECTO">';
						
						$contactos_todos.='<option value="0">SELECCIONA UN CONTACTO</option>';
						foreach ($query_lista as $datos) 
						{
							switch ($datos['tipo_contacto']) 
							{
								case 'AGENTE':
								$agentes.='<option value="'.$datos['id_contacto'].'">'.str_replace('_',' ',mb_strtoupper($datos['nombre_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_paterno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_materno_contacto'],'UTF-8')).'</option>';
									break;
								case 'SUBAGENTE':
									$subagentes.='<option value="'.$datos['id_contacto'].'">'.str_replace('_',' ',mb_strtoupper($datos['nombre_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_paterno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_materno_contacto'],'UTF-8')).'</option>';
									break;
								case 'EMPLEADO':
									$empleado.='<option value="'.$datos['id_contacto'].'">'.str_replace('_',' ',mb_strtoupper($datos['nombre_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_paterno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_materno_contacto'],'UTF-8')).'</option>';
									break;
								case 'CLIENTE_DIRECTO':
									$clientes_directos.='<option value="'.$datos['id_contacto'].'">'.str_replace('_',' ',mb_strtoupper($datos['nombre_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_paterno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_materno_contacto'],'UTF-8')).'</option>';
									break;
								
								default:
									# code...
									break;
							}
							

						}
						$agentes.='</optgroup>';
						$subagentes.='</optgroup>';
						$empleado.='</optgroup>';
						$clientes_directos.='</optgroup>';

						echo$contactos_todos.=$agentes.$subagentes.$empleado.$clientes_directos;
						exit();
						break;
					case 3:
						$lista="SELECT
						id_contacto,
						apellido_paterno_contacto,
						apellido_materno_contacto,
						nombre_contacto,
						tipo_contacto,
						telefono_contacto,
						correo_contaco,
						fecha_alta_contacto,
						u.nombre_persona
						FROM contactos 
						left join usuarios u on u.nombre_usuario=contactos.dio_alta_contacto
						where dio_alta_contacto=:dio_alta_contacto
						order by nombre_contacto asc";
						$query_lista=$conexion->prepare($lista);
						$query_lista->execute(array(
							":dio_alta_contacto"=>$usuario
						));
						foreach ($query_lista as $datos) 
						{

							$arreglo[$i]['numero']=$j;

							$arreglo[$i]['nombre_contacto']=str_replace('_',' ',mb_strtoupper($datos['apellido_paterno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['apellido_materno_contacto'],'UTF-8')).' '.str_replace('_',' ',mb_strtoupper($datos['nombre_contacto'],'UTF-8'));

							$arreglo[$i]['telefono']=$datos['telefono_contacto'];
							
							$arreglo[$i]['tipo_contacto']=str_replace('_',' ',mb_strtoupper($datos['tipo_contacto'],'UTF-8'));


							$arreglo[$i]['correo']=$datos['correo_contaco'];

							$arreglo[$i]['fecha_alta']=date('d-m-Y H:i:s',strtotime($datos['fecha_alta_contacto']));

							$arreglo[$i]['dio_alta']=$datos['nombre_persona'];

							$arreglo[$i]['botones']='
							<center><div style="border:0px red solid;width:70px;text-align:center">
							<div style="display:inline-block;">
							<button  style="width:29px;display:"   class="btn  btn-info btn-sm editar_contacto" value="'.$datos['id_contacto'].'"><i class="fas fa-edit"></i>
							</button>
							</div>
							
							<div style="display:inline-block;">
							<button class="btn btn-danger  btn-sm eliminar_contacto" value="'.$datos['id_contacto'].'">
								<i  class="fas fa-times"></i>
							</button>
							</div>
							</div></center>
							
							';
							
							$i++;
							$j++;
						}

						
						$datos_finales['data']=$arreglo;
						echo json_encode($datos_finales);
						exit();
						break;
				}
				
			}
			else
			{
				switch ($_POST['contactos_lista']) 
				{
					case 1:
						$datos_finales=array();
						$datos_finales['contacto']=$arreglo;
						echo json_encode($datos_finales);
						exit();	
						break;
					case 2:

						$contactos_todos.='<option value="0">NO HAY CONTACTOS REGISTRADOS</option>';
						echo$contactos_todos;
						exit();
					break;
					case 3:
						$datos_finales['data']=$arreglo;
						echo json_encode($datos_finales);
						exit();	
					break;
				}
				
			}
			
		}	
		else
		{
			echo'ERROR 362. LISTA DE CONTACTOS.NO SE PUEDE CONECTAR CON EL SERVIDOR';
		}
	} 
	catch (PDOException $e) 
	{
		echo $e;
	}
}
 ?>
